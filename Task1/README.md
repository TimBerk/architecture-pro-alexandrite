# Задание 1. Анализ, идентификация проблем и решений, планирование

## Что нужно сделать

1. Создайте в директории Task1 текстовый файл и назовите его «Планирование: анализ, идентификация проблем и поиск решений». Работайте над заданием в этом файле.
2. Проанализируйте схему и описание системы. Идентифицируйте существующие и потенциальные проблемные места. Напишите их список.
3. Разработайте инициативы, которые необходимы для устранения нежелательных ситуаций. Запишите их в список.
4. Расставьте инициативы в порядке приоритета. Опишите ход своих рассуждений и ответьте на вопросы:
   - Какой вы видите целевую архитектуру через полгода?
   - Если бы у вас была возможность выполнить только три пункта из списка инициатив в ближайшие полгода, что бы вы выбрали и почему? Не обязательно добавлять в список только эпики. Вы можете включить в план как крупные изменения, так и локальные задачи.

## Отчёт


### 1. Проблемные места

**Бизнес‑симптомы**

- Массовые просрочки заказов (B2C и B2B), жалобы, растущая потеря контрактов.
- Нагрузка растёт линейно, мощности производства хватает с запасом, значит проблемы в цифровом контуре.

**Технические и процессные проблемы (гипотезы)**

1. **Узкое место MES при расчёте цены и обработке 3D‑моделей**
   - Расчёт стоимости полностью завязан на MES. Затрачиваемое время 2–30 минут создает очереди задач при росте заказов.
   - Один инстанс MES, монолитный бэкенд на C# без горизонтального масштабирования и, вероятно, без явной очереди задач и воркеров.

2. **Неустойчивая/непрозрачная интеграция MES–CRM–онлайн‑магазин через RabbitMQ**
   - Нет описанных SLA по интеграционным очередям, ретраям, DLQ, идемпотентности и мониторингу.
   - Возможны потерянные/задвоенные сообщения, зависшие заказы в промежуточных статусах, отсутствие сквозной трассировки.

3. **Проблемы с обработкой API‑заказов (B2B)**
   - MES дергает внешний API «Александрита» для расчёта и/или создания заказа в CRM, что увеличивает связность и создаёт точку отказа.
   - Под нагрузкой сторонних продавцов (массовые запросы) очередь расчётов и сообщений растёт, CRM не успевает создавать заказы, статусы не обновляются.

4. **Отсутcтвие выделенного сервиса оркестрации заказов**
   - Бизнес‑процесс размазан по трём приложениям.
   - Изменения статусов делают разные системы, вероятны гонки, расхождения и сложность в отладке.

5. **Нагрузочные проблемы MES UI (дашборд операторов)**
   - Один инстанс MES и тяжёлые запросы по всем заказам/статусам создают долгую загрузку первой страницы.
   - Вероятно, нет индексов/оптимизации запросов по «новизне заказов» и статусам, возможно отсутствие отдельной read‑реплики под отчёты/дашборды.

6. **Инфраструктурные ограничения**
   - По одному инстансу каждого приложения и базы: отсутствие отказоустойчивости и масштабирования под линейный рост заказов.
   - Вероятно, нет изоляции пользовательских нагрузок и автоскейлинга.

7. **Отсутствие мониторинга и алертинга**
   - Проблемы выявляются по обращениям клиентов и операторов.
   - Нет дашбордов с метриками для RabbitMQ, времени расчёта MES, времени прохождения статусов заказа end‑to‑end.

8. **Процессы разработки и релизов**
   - Ручные релизы в release и prod, E2E‑тесты только ручные, любой баг может задержать релиз.
   - Отсутствует постепенный выпуск, нет автоматизированных регрессионных/нагрузочных тестов для интеграций.

9. **Командные ограничения**
   - Один DevOps, один C#‑разработчик при ключевой роли MES, ограниченный опыт с React.
   - Рост функциональности и нагрузки без усиления команды ведёт к техническому долгу и задержкам.


### 2. Список инициатив

1. **Наблюдаемость и метрики**
   - Ввод набора метрик по заказам (время в каждом статусе, общее время цикла, лид‑тайм, количество просрочек).
   - Создание дашбордов и алертов по RabbitMQ (глубина очередей, возраст сообщений, rate публикации/потребления) и по MES (время расчёта, количество активных задач).

2. **Диагностика и стабилизация интеграций**
   - Ввод: DLQ, повторов с backoff, идемпотентных ключей сообщений между MES и CRM.
   - Добавление логикb повторной синхронизации статусов заказа между CRM и MES.

3. **Декомпозиция расчёта стоимости и фоновая обработка**
   - Выделить в MES отдельный воркер для расчёта стоимости, который будет работать с очередью задач.
   - Ограничить concurrency, добавить приоритизацию и лимиты на общую нагрузку.

4. **Масштабирование MES и CRM**
   - Перевод MES и CRM в режим нескольких инстансов за балансировщиком.
   - Вынесение тяжёлых операций (расчёт, отчёты, массовые выборки) в отдельные воркеры/реплики БД.

5. **Пересмотр схемы статусов и SLA**
   - Чётко формализовать переходы между статусами, допустимые таймауты и реакции при их нарушении (авто‑эскалации, оповещения менеджеров).
   - Ввести сервис контроля SLA заказов.

6. **Изменения в процессах**
   - Автоматизация деплоя в release/prod с базовыми sanity‑/smoke‑тестами.
   - Внедрение автоматизированных E2E‑тестов по основным сценариям заказа, включая интеграцию через RabbitMQ.
   - Регулярные малые релизы (каждые 2 недели), чтобы не копить изменения.
   - Усиление команды по C# (ещё 1–2 разработчика на MES) и DevOps/SRE/React.


### 3. Приоритизация инициатив

#### Высокий приоритет (P0–P1, ближайшие 1–3 месяца)

- **Наблюдаемость и диагностика** - без метрик и логов сложно доказательно локализовать проблемы и контролировать улучшения. Дёшевое и быстрое решение, которое даёт основу для всех последующих решений.

- **Стабилизация интеграций и статусов заказов** - потерянные/зависшие заказы – самая болезненная история для клиентов и B2B‑партнёров. Добавление DLQ, ретраев, идемпотентности существенно снижает количество «пропавших» заказов.

- **Масштабирование и разгрузка MES** — MES является центральным и узким местом. Вынос расчёта стоимости в воркеры и масштабирование бэкенда прямо снижает задержки расчёта и уменьшает хвост в очередях, а оптимизация дашборда убирает тормоза у операторов.

#### Средний приоритет (P2):

- Улучшение процессов релиза и автоматизированных E2E.

#### Низкий/среднесрочный приоритет (P3):

- Пересмотр статусов и SLA с отдельным SLA‑сервисом.
- Расширение команды — по сути, стратегическая инициатива, но эффект от неё проявляется через несколько месяцев.


### 4. Целевая архитектура через полгода

Через полгода разумно целиться не в полную перестройку, а в «эволюционный 1‑й шаг»:

- **Масштабируемые бэкенды MES и CRM**
  - Несколько инстансов под балансировщиком, вынесенные фоновые воркеры для тяжёлых задач (расчёт стоимости, отчётность).
  - БД с read‑репликами для отчётных и read‑heavy сценариев (дашборд операторов, отчёты менеджеров).

- **Надёжная асинхронная интеграция через RabbitMQ**
  - Чётко описанные обменники/очереди, DLQ, ретраи, идемпотентность, мониторинг.
  - Метрики очередей и алерты встроены в ежедневную операционную практику.

- **Улучшенный B2B API**
  - Синхронный ответ «принято в обработку» + асинхронное уведомление/поллинг по расчёту стоимости и статусу заказа.
  - Ограничения по нагрузке и понятные SLA для партнёров.

- **Зрелый процесс релизов**
  - Автоматический деплой в prod после прохождения автотестов и ручного acceptance, релизы не реже раза в 2 недели.
  - Базовый набор автотестов для критического сквозного сценария заказа.


### 5. Если можно сделать только три инициативы

Если за полгода можно реализовать только три пункта, при текущих симптомах приоритетными будут:

1. **Ввести наблюдаемость и стабилизировать интеграции (инициативы 1 + 2 в минимальном объёме)**
   - Метрики, логи, трейсинг, дашборды по заказам и очередям.
   - DLQ, ретраи, идемпотентность и reconciliation статусов заказов между системами.
   Причина: это минимальный фундамент, который сразу уменьшает количество «пропавших» заказов и позволяет целенаправленно работать с проблемами.

2. **Разгрузить и масштабировать MES с выносом расчёта стоимости в фоновые воркеры (инициативы 3 + 4 частично)**
   - Очередь задач на расчёт, несколько воркеров, разумные лимиты и приоритизация (например, B2C выше B2B).
   - Запуск второго инстанса MES под балансировщиком.
   Причина: именно расчёт стоимости и MES — главный технический боттлнек; его устранение сокращает очереди и задержки.

3. **Оптимизировать дашборды и UX для операторов и менеджеров (инициатива 5 + простые отчёты по SLA)**
   - Быстрый дашборд «новые заказы» с корректной сортировкой и фильтрацией.
   - Отчёты/виджеты по просроченным заказам, по операторам, по B2B.
   Причина: операторы и менеджеры — последняя линия обороны перед клиентом; быстрый доступ к актуальным данным позволяет оперативно разруливать проблемы и снижать негатив.

Эти три направления вместе уже заметно снизят количество просроченных и «потерянных» заказов, позволят выдерживать рост нагрузки и дадут прозрачность как для внутренних пользователей, так и для B2B‑партнёров.
