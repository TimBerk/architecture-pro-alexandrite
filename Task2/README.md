# Задание 2. Мониторинг

Сайт «Александрит» подключён к Яндекс Метрике. Но с тех пор, как бизнес начал предоставлять оформление заказов через API, данные Яндекс Метрики уже не дают полной картины. Чтобы начать улучшать систему, вам нужно от чего-то отталкиваться. В этом задании вы запланируете внедрение мониторинга.

Вам нужно определить, что вы хотите измерять и как вы будете это делать. А затем —  постараться обосновать свои решения для бизнеса. Не забывайте: бизнесу не всегда очевидно, что мониторинг стоит того, чтобы выделять на него ресурсы команды.

## Что нужно сделать

1. **Создайте в директории Task2 текстовый файл и назовите его «Выбор и настройка мониторинга в системе»**. Вы будете оформлять своё решение в виде технического документа.
2. **Проанализируйте систему компании и C4-диаграмму в контексте планирования мониторинга**.
3. **Добавьте в файл раздел «Мотивация»**. Напишите здесь, почему в систему нужно добавить мониторинг и что это даст компании.
4. **Добавьте раздел «Выбор подхода к мониторингу»**. Выберите, какой подход к мониторингу вы будете использовать: RED, USE или «Четыре золотых сигнала». Для разных частей системы можно использовать разные подходы.
5. **Опишите, какие метрики и в каких частях системы вы будете отслеживать**. Перед вами список метрик. Выберите метрики, которые вы считаете нужным отслеживать. Для выбранных метрик напишите:
   - Зачем нужна эта метрика.
   - Нужны ли ярлыки для этой метрики. Если ярлыки нужны, опишите, какие именно вы планируете добавить. Вы можете не ограничивать себя только этим списком. Если вы видите, что стоит добавить какие-то ещё метрики, — добавьте и их тоже.
6. **Добавьте раздел «План действий»**. Напишите высокоуровнево, какие задачи вы видите для реализации. Это будет драфт технического задания. Например, «Создать инстанс time-series базы с использованием такой-то технологии».
7. **Дополнительное задание**. Выберите показатели насыщенности — определите, что является пороговым значением насыщенности и почему нужно использовать именно такие показатели. Опишите, что должно происходить в системе в случае, если эти параметры будут превышены. Например, нужно завести тикет, добавить инстансов, написать письмо в саппорт, добавить автоматическую «звонилку» и так далее. Если вы сдадите работу без этого пункта, это не повлияет на проверку задания ревьюером.

## Отчёт

### Мотивация

Бизнес уже не видит полную картину по заказам, потому что часть трафика и операций теперь идёт через B2B‑API, минуя витрину, а Яндекс Метрика фиксирует только веб‑поведение на сайте, но не состояние распределённой системы обработки заказов.  При этом у компании есть массовые просрочки заказов, потеря контрактов и жалобы на «пропавшие» заказы, а без технического мониторинга невозможно понять, где именно возникает проблема: в очередях сообщений, в MES, в CRM или на стороне партнёров.

Мониторинг даёт компании:
- прозрачность по состоянию ключевых бизнес‑процессов (скорость обработки заказов, просрочки, отказоустойчивость интеграций, загрузка MES/CRM);
- возможность проактивно реагировать до того, как клиенты начнут жаловаться (алерты по очередям, задержкам, ошибкам);
- фактическую базу для решений по масштабированию и развитию (не по ощущениям, а по метрикам нагрузки, ошибок и насыщенности).


### Выбор подхода к мониторингу

Для разных частей системы логично комбинировать подходы:

- **Пользовательские и B2B‑API (онлайн‑магазин, CRM API, MES API)**

  Подход: **Четыре золотых сигнала SRE** — latency, traffic, errors, saturation.

  Обоснование: важно измерять восприятие сервиса клиентами и партнёрами: скорость, частоту запросов, долю ошибок и насыщение ресурсов под этими запросами.

- **Инфраструктура и ресурсы (EC2, БД, RabbitMQ‑кластер)**

  Подход: **USE (Utilization, Saturation, Errors)**.

  Обоснование: для железа и баз важно видеть использование ресурсов, насыщенность и ошибки (например, переполнение очередей, ошибки подключения к БД).

- **Очереди RabbitMQ и асинхронные процессы**

  Комбинация: элементы **RED** (Rate, Errors, Duration) + **Четыре золотых сигнала SRE** (latency через «время в очереди») для обработки сообщений.

  Обоснование: нужно видеть, с какой скоростью публикуются/потребляются сообщения, как долго они живут в очереди и сколько сообщений «умирает» (DLX/DLQ).


### Метрики и ярлыки

#### 1. Очереди RabbitMQ

1. **Number of dead-letter-exchange letters in RabbitMQ**
   - Показатель количества «проблемных» сообщений (ошибки обработки, истёкший TTL, неверная маршрутизация).
   - Высокое значение = массовые сбои интеграций MES–CRM/B2B.
   - Ярлыки:
     - `queue` (имя очереди), `exchange` (имя DLX), `routing_key`, `source_system` (MES/CRM/shop/B2B).

2. **Number of message in flight in RabbitMQ**
   - Даёт картину, сколько сообщений ожидает обработки и насколько «забиты» очереди.
   - Рост без стабилизации = отставание потребителей и задержки статусов заказов.
   - Ярлыки:
     - `queue`, `message_type` (order_created, price_calculated, status_update и т. д.).

3. (Дополнительно) **Время в очереди (queue latency) per message_type**
   - Показывает задержки между событиями (например, от SUBMITTED до PRICE_CALCULATED).
   - Ярлыки:
     - `queue`, `message_type`, `source_system`, `destination_system`.

#### 2. API‑метрики (онлайн‑магазин, CRM, MES)

4. **Number of requests (RPS) for internet shop API / CRM API / MES API**
   - Позволяет видеть нагрузку, пики, отличие B2C и B2B сценариев, а также планировать масштабирование.
   - Ярлыки:
     - `service` (shop, crm, mes), `endpoint` (группировка по шаблонам URI), `method` (GET/POST/...), `client_type` (b2c, b2b, internal).

5. **Response time (latency) for shop API / CRM API / MES API**
   - Ключевой показатель качества для клиентов и партнёров.
   - Рост задержки на критичных эндпоинтах (создание заказа, получение статуса) напрямую бьёт по SLA.
   - Ярлыки:
     - `service`, `endpoint`, `method`, `client_type`, `status_code_class`.

6. **Number of HTTP 500 for shop API / CRM API / MES API**
   - Для отслеживания части ошибок - скачки 5xx сигнализируют об авариях, проблемах с БД, зависаниях внешних сервисов.
   - Ярлыки:
     - `service`, `endpoint`, `method`, `client_type`, при необходимости `error_type`.

7. **Number of HTTP 200 для ключевых сценариев**
   - Для бизнес‑отчётности — сколько успешных заказов создаётся/подтверждается; можно строить фреймворк по конверсии B2B/B2C.
   - Ярлыки:
     - `service`, `endpoint`, `client_type`, `channel` (web, api_partner, operator).

8. **Number of requests (RPS) per user for internet shop / CRM / MES**
   - Отлавливание аномального поведения и корректировка нагрузки с крупными партнёрами.
   - Ярлыки:
     - `service`, `user_id`/`partner_id`, `client_type`.

9. **Number of simultanious sessions for shop / CRM / MES API**
   - Отражение активности пользователей/партнёров для понимания пиковой нагрузки и планирования масштабирования.
   - Ярлыки:
     - `service`, `client_type`, `partner_id` (для B2B).

#### 3. Ресурсы приложений и БД (USE)

10. **CPU % for shop API / CRM API / MES API**
    - Показ утилизацию CPU; если CPU упирается в 80–90%, возрастает латентность и риск ошибок, нужен автоскейлинг или оптимизация.
    - Ярлыки:
      - `service`, `instance_id`, `environment` (dev/release/prod).

11. **Memory Utilisation for shop API / CRM API / MES API**
    - Для выявления утечек памяти, GC‑проблем.
    - Ярлыки:
      - `service`, `instance_id`, `environment`.

12. **Memory Utilisation for shop db instance / MES db instance**
    - Для определения насыщения БД.
    - Ярлыки:
      - `db_type` (shop, mes), `instance_id`, `environment`.

13. **Number of connections for shop db instance / MES db instance**
    - Для выявления проблем с подключениями - неправильные пулы, а также превышение лимитов БД.
    - Ярлыки:
      - `db_type`, `application` (shop, crm, mes), `instance_id`.

14. **Size of shop db instance / Size of MES db instance**
    - Для планирования capacity и понимания необходимости шардирование/архивация.
    - Ярлыки:
      - `db_type`, `environment`.

15. **Kb transferred (received) / Kb provided (sent) for shop / CRM / MES API**
    - Для контроля сетевого трафика, поиск аномалий и оценка влияния крупных партнёров (например, массовая заливка 3D‑моделей).
    - Ярлыки:
      - `service`, `direction` (in,out), `client_type`, `partner_id`.

16. **Size of S3 storage** (хранилище 3D‑моделей)
    - Для отслеживание роста объёма 3D‑файлов, оценка стоимости и необходимости архивирования/политик лайфтайма.
    - Ярлыки:
      - `bucket`, `environment`, `file_type` (3d_model, preview, export).

#### 4. Бизнес‑ориентированные метрики

17. **Время прохождения заказов по статусам (INITIATED → CLOSED) и по ключевым переходам (SUBMITTED → PRICE_CALCULATED, PRICE_CALCULATED → MANUFACTURING_STARTED, MANUFACTURING_STARTED → SHIPPED)**
    - Для определения end‑to‑end latency и узких мест бизнес‑процесса.
    - Ярлыки:
      - `status_from`, `status_to`, `channel` (web, api_partner), `product_type` (готовое, кастомный дизайн), `complexity` (простое/сложное изделие по 3D‑модели), `partner_id`.

18. **Количество просроченных заказов относительно обещанного срока (3 недели) и их доля от общего числа**
    - Для отслеживания ошибок с заказами, жалоб и потерь контрактов.
    - Ярлыки:
      - `channel`, `partner_id`, `product_type`, `reason` (delay_pricing, delay_production, delay_shipping — если возможно классифицировать).

### План действий

Высокоуровневый план внедрения мониторинга:

1. **Выбор и развёртывание стека мониторинга**
   - Создать инстанс time‑series базы и системы мониторинга (например, Prometheus + Grafana + Alertmanager) в облаке, с учётом прод‑нагрузки.
   - Настроить резервное копирование и доступы для мониторинга.

2. **Инструментирование приложений (Java Spring Boot, C# MES)**
   - Включить Micrometer/Actuator в Spring Boot‑сервисах и аналогичные библиотеки для C#‑бэкенда MES для экспорта метрик в формате Prometheus.
   - Добавить кастомные метрики по ключевым бизнес‑сценариям.

3. **Интеграция с RabbitMQ**
   - Подключить экспортер RabbitMQ к Prometheus, собирать метрики по очередям.
   - Стандартизировать именование очередей и routing‑keys по типам событий заказов.

4. **Инфраструктурные метрики (EC2, БД, S3)**
   - Настроить сбор стандартных метрик инфраструктуры через менеджед‑мониторинг экспортеры в Prometheus.

5. **Дашборды по золотым сигналам и бизнес‑метрикам**
   - Создать набор Grafana‑дашбордов:
     - для SRE/DevOps: золотые сигналы по каждому сервису и очередям;
     - для бизнеса: заказы по статусам, время обработки, просрочки, B2B‑партнёры.

6. **Настройка алертинга и процессов реагирования**
   - Определить пороговые значения насыщенности и ошибок, завести правила в Alertmanager, прописать каналы уведомлений (Slack/почта/звонки).
   - Формализовать runbook’и: что делать при срабатывании каждого типа алерта.

7. **Интеграция мониторинга в CI/CD и практики команды**
   - Добавить базовые проверки доступности /‑health и метрик в pipeline (smoke‑тесты после деплоя).
   - Встроить анализ метрик в еженедельные/спринтовые ретро (обсуждение инцидентов и трендов).


### Дополнительно: показатели насыщенности и реакция системы

1. **RabbitMQ: Number of message in flight + время в очереди**
   - Порог:
     - предупреждение, если среднее время в очереди > 3 минут для критичных очередей (создание заказа, расчёт цены);
     - критично, если > 5–10 минут или глубина очереди выросла более чем в 5 раз от среднего за последние N дней.
   - Реакция:
     - автоматическое создание тикета/инцидента;
     - уведомление DevOps/SRE и ответственных за MES/CRM;
     - при повторяемости — задача на масштабирование воркеров MES и/или оптимизацию потребителей, временное ограничение B2B‑трафика.

2. **CPU % for MES API и воркеров расчёта**
   - Порог:
     - предупреждение при 70–80% CPU в течение 10–15 минут;
     - критично при > 90% CPU в течение 5 минут.
   - Реакция:
     - автоскейлинг инстансов MES (если включён) либо явная задача DevOps на масштабирование;
     - тикет на анализ горячих точек (профилирование, оптимизация расчёта).

3. **Memory utilisation для MES/CRM API и БД**
   - Порог:
     - предупреждение при > 75–80% памяти;
     - критично при > 90% или частых GC‑пиках / OOM.
   - Реакция:
     - тикет на анализ утечек и настройки JVM/.NET;
     - при необходимости временное увеличение ресурсов/перекладка воркеров.

4. **Количество сообщений в DLX (dead-letter) RabbitMQ**
   - Порог:
     - предупреждение при стабильном росте DLX более чем на X сообщений в час/день;
     - критично при резком скачке (например, > 1000 сообщений в DLX за 5–10 минут).
   - Реакция:
     - автоматическое создание инцидента;
     - разбор причин (регресс интеграции, баг в потребителе, неверный формат сообщений);
     - при необходимости — временное отключение проблемного продьюсера/партнёра и ручная/полуавтоматическая переобработка DLX.

5. **Насыщенность по времени обработки заказов (business saturation)**
   - Порог:
     - предупреждение, если медианное время от SUBMITTED до PRICE_CALCULATED стабильно > 30 минут (для сложных моделей можно учитывать отдельный SLO);
     - критично, если 90‑перцентиль превышает обещанные 3 недели для всего цикла или доля просроченных заказов > N % (например, > 5%).
   - Реакция:
     - уведомление бизнес‑ответственных и техкоманды;
     - включение плана по временным ограничениям B2B‑приёма, перераспределению заказов между операторами, срочному масштабированию MES/CRM и пересмотру SLA.

Типы реакций для всех вышеперечисленных насыщенностей:

- автоматическое создание инцидента в системе поддержки;
- уведомления в оперативные каналы;
- обязательный пост‑мортем после инцидентов.
